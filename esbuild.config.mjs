import obPlugin from "@aidenlx/esbuild-plugin-obsidian";
import builtins from "builtin-modules";
import { build } from "esbuild";
import { lessLoader } from "esbuild-plugin-less";
import escape from "escape-string-regexp";

import inlineWorker from "./scripts/inline-worker.mjs";

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source visit the plugins github repository
*/
`;

const isProd = process.env.BUILD === "production";

/** @type import("esbuild").BuildOptions */
const opts = {
  bundle: true,
  watch: !isProd,
  platform: "browser",
  external: ["obsidian", "electron", "@electron/remote", ...builtins],
  format: "cjs",
  mainFields: ["browser", "module", "main"],
  sourcemap: isProd ? false : "inline",
  minify: isProd,
  define: {
    "process.env.NODE_ENV": JSON.stringify(process.env.BUILD),
  },
  loader: {
    ".sql": "text",
  },
};
try {
  const main = await build({
    ...opts,
    entryPoints: ["src/obsidian/zt-main.ts"],
    banner: { js: banner },
    outfile: "build/main.js",
    tsconfig: "src/obsidian/tsconfig.json",
    incremental: true,
    plugins: [
      lessLoader(),
      inlineWorker(
        {
          ...opts,
          watch: !isProd
            ? {
                onRebuild: (error) => {
                  if (error) console.error("watch build failed:", error);
                  else main.rebuild();
                },
              }
            : false,
          tsconfig: "src/db-worker/tsconfig.json",
          external: [...builtins],
          format: "cjs",
          define: {
            "process.env.NODE_ENV": JSON.stringify(process.env.BUILD),
          },
        },
        // replace code with determined path arg passed to worker
        [[new RegExp(escape("__ob_cfg_dir"), "g"), 0]],
      ),
      obPlugin(),
    ],
  });
} catch (err) {
  console.error(err);
  process.exit(1);
}
